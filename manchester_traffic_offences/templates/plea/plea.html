{% extends "plea/base.html" %}

{% load debug %}
{% load i18n %}
{% load form_widgets %}
{% load testing %}

{% block page_title %}{% include "plea/plea/page_title.html" with charges=request.session.case.number_of_charges %} - {{ block.super }}{% endblock %}

{% block page_content %}

    {% with request.session.case.number_of_charges as charges %}
<form action="{{ request.path }}" method="post" autocomplete="off" novalidate>

    {% csrf_token %}

    <input type="hidden" name="nojs" value="{{plea.nojs|default:"guilty"}}">

    {% if formset_has_errors %}
    <section class="error-summary">
        <h2>{% trans "You need to fix the errors on this page before continuing." %}</h2>

        <p>{% trans "See highlighted errors below." %}</p>

        <ul>
        {% for plea_form in form %}
            {% for field in plea_form %}
                {% if field.errors %}
        <li><a href="#section_{{ field.name }}_{{ forloop.parentloop.counter }}">{{ field.errors|striptags }}</a></li>
                {% endif %}
            {% endfor %}
        {% endfor %}
        </ul>
    </section>
    {% endif %}

    <header class="content-header">
        <h1>{% include "plea/plea/page_title.html" %}</h1>
        {% if plea.nojs == "nojs_last_step" %}
        <div>
            <p>This is your opportunity to present your case to the court.</p>
        </div>
        {% endif %}
    </header>

    {% if plea.nojs != "nojs_last_step" %}
    <div class="panel-grey">
        {% if case.plea_made_by == "Defendant" %}
        <p>{% blocktrans %}This is your opportunity to present your case to the court:{% endblocktrans %}</p>
        <ul>
            <li>{% blocktrans %}each offence may carry penalty points and a fine{% endblocktrans %}</li>
            <li>{% blocktrans %}if you're convicted you'll have to pay the Criminal Courts Charge – this is added to any other penalty imposed by the court{% endblocktrans %}</li>
            <li>{% blocktrans %}if you plead guilty you may get a 33% reduction on any fine{% endblocktrans %}</li>
        </ul>
        {% endif %}

        {% if case.plea_made_by == "Company representative" %}
        <p>{% blocktrans %}This is your opportunity to present the company's case to the court:{% endblocktrans %}</p>
        <ul>
            <li>{% blocktrans %}each offence may result in a fine{% endblocktrans %}</li>
            <li>{% blocktrans %}if convicted, the company will have to pay the Criminal Courts Charge – this is added to any other penalty imposed by the court{% endblocktrans %}</li>
            <li>{% blocktrans %}if you plead guilty on its behalf, the company may get a 33% reduction on any fine{% endblocktrans %}</li>
        </ul>
        {% endif %}
    </div>
    {% endif %}

    {% with form_count=form|length %}

        {{ form.management_form }}

        {% if plea.nojs != "nojs_last_step" %}
        <h2 class="heading-medium">{% blocktrans with form_count=form_count count charges=charges %}Enter a plea for the charge below{% plural %}Enter {{ form_count }} pleas for the charges below{% endblocktrans %}</h2>
        {% endif %}

        {% for plea_form in form %}
        <section class="section-plea">

            {% if plea.nojs == "nojs_last_step" %}
            {% add_test_tag "<<NOJSTRIGGERSUMMARY>>" %}
            <div class="nojs-hidden">
                {% with plea_form as form %}
                    {% include "widgets/plea_radio_field.html" %}
                {% endwith %}
            </div>
            <div class="form-header-pleas js-hidden">
                {% if form_count > 1 or form.guilty.errors %}
                <fieldset>
                    <legend class="form-label-bold">
                    {% if form_count > 1 %}
                        <div class="label-line">
                            <span class="label-text">{% blocktrans with counter=forloop.counter %}Charge {{ counter }}{% endblocktrans %}</span>
                        </div>
                    {% endif %}
                    </legend>
                </fieldset>
                {% endif %}

                <p class="form-selected">{% if plea_form.guilty.value == "guilty" %}{% trans "Your plea - Guilty" %}{% else %} {% trans "Your plea - Not guilty" %}{% endif %}</p>
                <a href="{{ request.path }}?reset">{% trans "Change this plea" %}</a>
            </div>
            {% else %}
                {% with plea_form as form %}
                    {% include "widgets/plea_radio_field.html" %}
                {% endwith %}
            {% endif %}

            <div class="panel-indent" data-conditional-trigger="{{ plea_form.prefix }}-guilty" data-conditional-value="^(guilty|not_guilty)$">

                <section id="section_guilty_extra_{{ forloop.counter }}" class="js-Conditional js-hidden{% if plea.nojs != "nojs_last_step" or plea_form.guilty.0.value != "guilty" %} nojs-hidden{% endif %}" data-conditional-trigger="{{ plea_form.prefix }}-guilty" data-conditional-value="^guilty$">

                    {% if case.plea_made_by == "Defendant" %}
                        {% std_field plea_form.guilty_extra %}
                    {% else %}
                        {% std_field plea_form.guilty_extra help_text=_("What would the defendant like the court to consider?") %}
                    {% endif %}

                    <h4 class="heading-small">{% trans "Pleading guilty to this charge means:" %}</h4>
                    <ul>
                        {% if case.plea_made_by == "Defendant" %}
                        <li>{% blocktrans %}you <strong>do not</strong> need to come to court to respond to this charge{% endblocktrans %}</li>
                        <li>{% blocktrans %}we'll send you details of the court's decision and what happens next{% endblocktrans %}</li>
                        {% endif %}

                        {% if case.plea_made_by == "Company representative" %}
                        <li>{% blocktrans %}a company representative <strong>does not</strong> need to come to court to respond to this charge{% endblocktrans %}</li>
                        <li>{% blocktrans %}we'll send details of the court's decision and what to do next{% endblocktrans %}</li>
                        {% endif %}
                    </ul>
                </section>

                <section id="section_not_guilty_extra_{{ forloop.counter }}" class="js-Conditional js-hidden{% if plea.nojs != "nojs_last_step" or plea_form.guilty.0.value != "not_guilty" %} nojs-hidden{% endif %}" data-conditional-trigger="{{ plea_form.prefix }}-guilty" data-conditional-value="^not_guilty$">

                    {% if case.plea_made_by == "Defendant" %}
                        {% wide_field plea_form.not_guilty_extra hide_optional=True %}
                    {% else %}
                        {% wide_field plea_form.not_guilty_extra hide_optional=True help_text=_("Tell us why the company believes they are not guilty") %}
                    {% endif %}

                    <h4 class="heading-small">{% trans "Pleading not guilty to this charge means:" %}</h4>
                    <ul>
                        <li>{% blocktrans %}<strong>Do not</strong> come to court on the hearing date in the requisition pack – we'll send you details of what happens next.{% endblocktrans %}</li>
                    </ul>

                </section>
            </div>

        </section>
        {% endfor %}

    {% endwith %}

    <div class="form-submit">
        <button class="button" type="submit">{% trans "Continue" %}</button>
    </div>
</form>
    {% endwith %}
{% endblock page_content %}
