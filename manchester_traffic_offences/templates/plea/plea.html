{% extends "plea/base.html" %}

{% load debug %}
{% load i18n %}

{% block page_title %}{{ block.super }} Your plea{% endblock %}

{% block page_content %}

    {% with request.session.case.number_of_charges as charges %}
<form action="{{ request.path }}" method="post" autocomplete="off" novalidate>

    {% csrf_token %}

    {% if formset_has_errors %}
    <section class="error-summary">
        <h2 class="heading-medium">{% trans "You need to fix the errors on this page before continuing." %}</h2>
        
        <p>{% trans "See highlighted errors below." %}</p>
        
        <ul class="errors-list">
        {% with forms.0 as formset %}
            {% for form in formset %}
                {% for field in form %}
                    {% if field.errors %}
            <li><a href="#section_{{ field.name }}_{{ forloop.parentloop.counter }}">{{ field.errors|striptags }}</a></li>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endwith %}
        </ul>
    </section>
    {% endif %}

    <header class="content-header">
        <h1 class="heading-xlarge">
            {% blocktrans count charges=charges %}Your plea{% plural %}Your pleas{% endblocktrans %}</h1>

        <p class="lede">{% trans "This is your opportunity to present your case to the court." %}</p>
    </header>

    {% with formset=forms.0 form_count=forms.0|length %}

        {{ formset.management_form }}

        <h2 class="heading-medium">
            {% blocktrans with form_count=form_count count charges=charges %} Enter a plea for the charge below {% plural %} Enter {{ form_count }} pleas for the charges below {% endblocktrans %}</h2>

        {% for form in formset %}
        <fieldset id="section_guilty_{{ forloop.counter }}">
            {% if form_count > 1 %}<legend class="form-label">
            {% blocktrans with counter=forloop.counter %} Your plea for charge [{{ counter }}] {% endblocktrans %}

            </legend>{% endif %}

            <div class="form-group inline{%  if form.guilty.errors %} with-error{% endif %}">
                
                {% if form.guilty.errors %}
                <div class="validation-message">{{ form.guilty.errors }}</div>
                {% endif %}

                {% for choice in form.guilty %}
                <label for="id_{{ choice.name }}_{{ choice.choice_value }}" class="block-label">
                    <input id="id_{{ choice.name }}_{{ choice.choice_value }}" type="radio" name="{{ choice.name }}" value="{{ choice.choice_value }}" {% if choice.is_checked %}checked="checked"{% endif %}>
                    {{ choice.choice_label }}
                </label>
                {% endfor %}
            </div>

            <div id="section_mitigations_{{ forloop.counter }}" class="panel-indent form-group">
                <div id="{{ form.guilty.0.name }}_guilty_extra" class="js-Conditional js-hidden" data-conditional-trigger="{{ form.prefix }}-guilty" data-conditional-value="^guilty$">
                    <label for="{{ form.mitigations.id_for_label }}">{% blocktrans %}Special circumstances <span class="form-hint-inline">(optional){% endblocktrans %}</span>
                        <span class="form-hint">{% trans "What would you like the court to consider?" %}</span>
                    </label>
                </div>

                <div id="{{ form.guilty.0.name }}_not_guilty_extra" class="js-Conditional js-hidden" data-conditional-trigger="{{ form.prefix }}-guilty" data-conditional-value="^not_guilty$">
                    <label for="{{ form.mitigations.id_for_label }}">{% blocktrans %}Not guilty because? <span class="form-hint-inline">(optional){% endblocktrans %}</span>
                        <span class="form-hint">{% trans "Tell us why you believe you are not guilty." %}</span>
                    </label>
                </div>

                {{ form.mitigations.errors }}

                <textarea maxlength="5000" rows="4" cols="50" name="{{ form.mitigations.html_name }}" id="{{ form.mitigations.id_for_label }}" class="form-control-wide js-Conditional js-hidden" data-conditional-trigger="{{ form.prefix }}-guilty" data-conditional-value="^(guilty|not_guilty)$">{{ form.mitigations.value|default_if_none:"" }}</textarea>
            </div>
        </fieldset>


        {% endfor %}

    {% endwith %}

    <div class="form-group form-submit">
        <button class="button" type="submit">{% trans "Continue" %}</button>
    </div>
</form>
    {% endwith %}
{% endblock page_content %}
